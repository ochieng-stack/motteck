<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>motteck</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='trains.css') }}">
</head>
<body>
    <header>
        <div class="header">
            <h1 class="title">
                <a href="{{ url_for('home') }}" style="text-decoration: none; color: inherit ;"><i>MOTTECK</i></a>
            </h1>
            </div>
            <!-- category Navigation-->  
            <nav class="category-nav">
                    <a href="{{ url_for('cars') }}" class="{% if active_page == 'cars'%} active{% endif %}">CARS</a>
                    <a href="{{ url_for('trucks') }}" class="{% if active_page == 'trucks'%} active{% endif %}">TRUCKS</a>
                    <a href="{{ url_for('motobikes') }}" class="{% if active_page == 'motobikes'%} active{% endif %}">MOTOBIKE</a>
                    <a href="{{ url_for('trains') }}" class="{% if active_page == 'trains'%} active{% endif %}">TRAIN</a>
                    <a href="{{ url_for('plane') }}" class="{% if active_page == 'plane'%} active{% endif %}">PLANE</a>
                    <a href="{{ url_for('services') }}" class="{% if active_page == 'services'%} active{% endif %}">SERVICES</a>
            </nav>
        </div>
    </header>
    <section>

        <!-- Post form-->
         {% if logged_in %}
         <form id="postform" method="POST" action="/add_post" enctype="multipart/form-data">
            <input type="hidden" name="category" value="train">
            <input type="text" id="title" name="title" placeholder="train Title" required>
            <!-- IMAGE UPLOAD -->
            <input type="file" id="image" name="image" accept="image/*" required>
            <textarea  name="description" id="description" placeholder="short description" required></textarea>
            <button type="submit">publish Post</button>
         </form>
         {% endif %}
         <h2>TRAINS</h2>
         <div id="trainPost" class="post-container"></div>
    </section>
    <script src="{{ url_for('static', filename='post-manager.js')}}"></script>
    <script>
        const category = 'train';
        const form = document.getElementById('postform');
        const container = document.getElementById('trainPost');
        
        function setupSeeMoreButtons(){
            const card = document.querySelectorAll('.post-card');
            card.forEach(card => {
                const seeMoreBtn = card.querySelector('.see-more-btn');
                const postText = container.querySelector('.post-text');

                if (!seeMoreBtn || !postText) return;

                const fullText = postText.innerHTML.trim();

                //if text is short,hide the see more button
                if (postText.scrollHeight <= 250) {
                    seeMoreBtn.style.display = "none";
                    return;
                }

                const shortText = fullText.slice(0,250) + '...';
                let expanded = false;
                postText.innerHTML = shortText;

                seeMoreBtn.addEventListener("click", () => {
                    expanded = !expanded;

                    card.classList.toggle("expanded");
                    
                    postText.innerHTML = expanded ? fullText : shortText;
                    seeMoreBtn.textContent = expanded ? "see less" : "see more";
                });
            });
        }
        
        // Display existing posts
        function showPosts(){
            getPostBycategory(category).then(posts => {
                container.innerHTML= '';
                if (!posts || posts.length === 0) {
                    container.innerHTML = `<p sytle="color:white;">No posts found.</p>`;
                    return;
                }
            posts.sort((a, b) => new Date(b.date) - new Date(a.date));

            posts.forEach(post => {
                const card = document.createElement('div');
                card.classList.add('post-card');
                card.innerHTML = `<img src="${post.image}" alt="${post.title}" class="post-image">
                <div class="post-content">
                <h3 class="post-title">${post.title}</h3>
                <p class="post-text">${post.description.replace(/\n/g, '<br>')}</p>
                <div class="post-actions">
                    <button id="like-btn-${post.id}" class="like-btn" onclick="likePost('${post.id}')">Like(<span id="like-count-${post.id}">${post.likes || 0}</span>)</button>                                      

                    {% if logged_in %}
                    <button class="delete-btn" onclick="deletePost('${post.id}')">DELETE</button>
                    {% endif %}
                    <button class="see-more-btn"> See more</button>
                </div>    
                </div>`;
                container.prepend(card);
            });
            // setup see more after all posts are added
            setupSeeMoreButtons();
            });
        };

        function getPostBycategory(category){
            return fetch('/get_posts?t=' + new Date().getTime())
            .then(response =>{
                if(!response.ok){
                    throw new Error('Failed to load posts');
                }
                return response.json();
            })
            .then(allPosts => {
                return allPosts.filter(post => post.category === category);
            })
            .catch(error => {
                console.error('Error loading posts:', error);
                return[];
            });
        } 
        // only add form listener if admin is logged in (form exists)
        if (form) {
            form.addEventListener('submit', e => {

                const title = document.getElementById('title').value;
                const image = document.getElementById('image').value;
                const description = document.getElementById('description').value;

                savePost(category, title, image, description);
                showPosts();
                form.reset();
                alert('Post published successfully!');
            });
        }

        function likePost(postId){
            const button = document.getElementById(`like-btn-${postId}`);
            const countSpan = document.getElementById(`like-count-${postId}`);
            const likedKey = `liked-${postId}`;

            //prevent user from liking twice on the same device
            if (localStorage.getItem(likedKey)) {
                alert("You already liked this post!");
                return;
            }

            fetch(`/like/${postId}`,{method:'POST', headers : {
                "content-type": "application/json"
            }})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    //update like count on screen
                    countSpan.textContent = data.likes;

                    // mark as liked
                    localStorage.setItem(likedKey, "true");

                    // Change button color
                    button.stle.backgroundColor = "#6eefc";
                } else {
                    console.error("Error:", data.error);
                }
            })
            .catch(error => console.error('Error:', error));

            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll("[id^='like-count-']").forEach(span => {
                    const postId = span.id.replace("like-count-", "");

                    fetch(`/like/${postId}`)
                    .then(res => res.json())
                    .then(data => {
                        span.textContent = data.likes;

                        //Changes button color if already liked on this brower
                        const likedKey = `liked-${postId}`;
                        const button = document.getElementById(`like-btn-${postId}`);
                        if (localStorage.getItem(likedKey) && button) {
                            button.style.backgroundColor = "#d6eefd";
                        }
                    });
                });
            });
        }

        function savePost(category, title, image, description) {
            const postData = {
                category: category,
                title: title,
                image: image,
                description: description
            };

            fetch('/add_post', {
                method: 'POST', headers: {'content-type':'application/json'},body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok){
                    throw new Error("Failed to save post");
                }
                return response.json();
            })
            .then(data => {
                if (data.success){
                    alert('post saved successfully!');
                    showPosts(); // refresh displayed posts
                } else {
                    alert('Failed to save post.');
                }
            })
            .catch(error => {
                console.error('Error saving post:', error);
                alert('Error occurred while saving the post.');
            });
        }

        function deletePost(postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                fetch(`/delete_post/${postId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok){
                        throw new Error("Filed to delete post");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success){
                        alert("Post deleted successfully!");
                        location.reload(); //refresh to reflect deletion
                    } else {
                        alert("An error occured while deleting the post.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occured while deleting the post.");
                });
            }
        }

        //always show posts, even for visitors
        showPosts();
    </script>
</body>
</html>